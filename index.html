<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icons/6.6.6/css/flag-icons.min.css">
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Include DataTables JS library -->
    <script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
    <!-- Include colReorder extension -->
    <script src="https://cdn.datatables.net/colreorder/1.5.3/js/dataTables.colReorder.min.js"></script>
    <title>Cyberbro</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --background-color: #f8f9fa;
            --text-color: #343a40;
            --border-color: #ced4da;
            --border-radius: 5px;
            --dark-background-color: #1e2a36;
            --dark-text-color: #d1d1d1;
            --dark-border-color: #3a4b5a;
            --dark-primary-color: #3a4b5a;
            --dark-primary-hover-color: #4b5c6d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }

        .container {
            width: 80%;
            margin: 0 auto;
            padding: 20px;
        }

        .container input[type="checkbox"] {
            accent-color: var(--primary-color);
        }

        textarea {
            width: 100%;
            height: 100px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            font-size: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        th,
        td {
            padding: 15px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        th {
            background-color: #e9ecef;
        }

        .btn {
            padding: 10px 20px;
            margin: 10px 0;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: var(--primary-hover-color);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.875rem;
        }

        .radio-container {
            background: #fff;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: inline-block;
            padding: 5px;
            font-size: 0.875rem;
            color: var(--text-color);
        }

        .radio-container label {

            border: 1px solid transparent;
            border-radius: var(--border-radius);
            display: inline-block;
            height: 26px;
            line-height: 26px;
            margin: 0;
            padding: 0;
            text-align: center;
            transition: .2s all ease-in-out;
            width: 100px;
        }

        .radio-container input[type="radio"] {
            display: none;
        }

        .radio-container label:hover {
            background: var(--primary-hover-color);
            color: white;
        }

        .radio-container input[type="radio"]:checked+label:hover {
            background: var(--primary-hover-color);
            color: white;
        }

        .radio-container input[type="radio"]:checked+label {
            background: var(--primary-color);
            color: white;
        }



        .high-risk {
            background-color: #dc3545;
            color: black;
        }

        .high-detection {
            background-color: #dc3545;
            color: black;
        }

        .clean-detection {
            background-color: #28a745;
            color: black;
        }

        .warning-row {
            background-color: #ffc107;
            color: black;
        }

        .filter-input,
        .filter-select {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: calc(100% - 22px);
            font-size: 1rem;
        }

        .filter-input:focus,
        .filter-select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filters-container .filter-input,
        .filters-container .filter-select,
        .filters-container .btn {
            flex: 1;
            min-width: 150px;
        }

        tr:hover {
            background-color: rgba(241, 241, 241, 0.5);
            color: black;
        }

        .warning-row:hover {
            background-color: rgba(255, 193, 7, 0.5);
        }

        .high-risk:hover {
            background-color: rgba(220, 53, 69, 0.5);
        }

        .high-detection:hover {
            background-color: rgba(220, 53, 69, 0.5);
        }

        .clean-detection:hover {
            background-color: rgba(40, 167, 69, 0.5);
        }

        body.dark-mode {
            background-color: var(--dark-background-color);
            color: var(--dark-text-color);
        }

        body.dark-mode th {
            background-color: #2b3a47;
        }

        body.dark-mode td,
        body.dark-mode th {
            border-color: var(--dark-border-color);
        }

        body.dark-mode .filter-input,
        body.dark-mode .filter-select {
            background-color: #2b3a47;
            color: var(--dark-text-color);
            border-color: var(--dark-border-color);
        }

        body.dark-mode .filter-input:focus,
        body.dark-mode .filter-select:focus {
            border-color: var(--dark-primary-hover-color);
        }

        .dark-mode-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .dark-mode-toggle:hover {
            background-color: var(--primary-hover-color);
        }

        body.dark-mode tr:hover {
            background-color: #2b3a47;
            color: var(--dark-text-color);
        }

        .github-logo-light {
            display: block;
        }

        .github-logo-dark {
            display: none;
        }

        body.dark-mode .github-logo-light {
            display: none;
        }

        body.dark-mode .github-logo-dark {
            display: block;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s;
        }

        a:hover {
            color: var(--primary-hover-color);
        }

        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 10px 0;
        }

        .footer nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .footer nav ul li {
            display: inline;
        }

        .footer nav ul li a {
            color: white;
            text-decoration: none;
            font-size: 1rem;
        }

        .footer nav ul li a:hover {
            color: var(--primary-hover-color);
        }

        .card {
            flex: 1;
            min-width: 250px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin-top: 0;
        }

        .card p {
            margin: 10px 0;
        }

        .cards-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
        }

        .cards-results-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
        }

        .end-of-cards {
            padding: 20px;
        }

        body.dark-mode .card {
            background-color: var(--dark-background-color);
            border-color: var(--dark-border-color);
        }

        @media (max-width: 500px) {
            .cards-results-container {
                flex-direction: column;
            }

            .card {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">
            <img id="darkModeIcon" src="https://img.icons8.com/ios-filled/50/ffffff/moon-symbol.png" alt="Dark Mode"
                width="20" height="20">
        </button>

        <a href="https://github.com/stanfrbd/cyberbro" target="_blank" class="github-logo">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/91/Octicons-mark-github.svg" alt="GitHub Logo"
                width="40" height="40" class="github-logo-light">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/91/Octicons-mark-github.svg" alt="GitHub Logo"
                width="40" height="40" class="github-logo-dark" style="filter: invert(1);">
        </a>
        <div id="startForm">
            <h1>Cyberbro - Observable Analysis</h1>

            <form id="analyzeForm" method="POST" action="/analyze">
                <label for="observables">Paste your observables here</label><br><br>
                <textarea name="observables" placeholder="1.2.3.4
example.com
d41d8cd98f00b204e9800998ecf8427e
chrome extension id
Or just IoC (plain text, separated, html, json, csv, log data, garbage data, fanged data [.] [dot] hxxp, etc.)"
                    required></textarea>
                <br>

                <div>
                    <h3 title="Use your mouse to hover over the engine name to see what it does">Select the engines to
                        use</h3>
                </div>
                <div>
                    <script>
                        const GUI_ENABLED_ENGINES = JSON.parse('{% if GUI_ENABLED_ENGINES | length > 0 %} {{ GUI_ENABLED_ENGINES | tojson }} {% else %} [] {% endif %}');
                        const allEngines = [
                            { name: "reverse_dns", label: "Reverse DNS", supports: "default domain ip abuse free_no_key", checked: true, title: "Performs a reverse DNS lookup for IP, domain, URL (on your machine)" },
                            { name: "rdap", label: "RDAP (ex Whois)", supports: "default abuse domain free_no_key", checked: true, title: "Checks RDAP (ex Whois) record for domain, URL, no API key required" },
                            { name: "ipquery", label: "IPquery", supports: "default ip risk vpn proxy free_no_key", checked: true, title: "Checks IPquery for IP, reversed obtained IP for a given domain / URL, free, no API key" },
                            { name: "abuseipdb", label: "AbuseIPDB", supports: "risk", checked: false, title: "Checks AbuseIPDB for IP, reversed obtained IP for a given domain / URL, free API key required" },
                            { name: "ipinfo", label: "IPinfo", supports: "ip", checked: false, title: "Checks IPinfo for IP, reversed obtained IP for a given domain / URL, free API key required" },
                            { name: "virustotal", label: "VirusTotal", supports: "hash risk ip domain url", checked: false, title: "Checks VirusTotal for IP, domain, URL, hash, free API key required" },
                            { name: "spur", label: "Spur.us", supports: "vpn proxy free_no_key scraping", checked: false, title: "Scraps Spur.us for IP, reversed obtained IP for a given domain / URL, free, no API key" },
                            { name: "mde", label: "Microsoft Defender for Endpoint", supports: "hash ip domain url", checked: false, title: "Checks Microsoft Defender for Endpoint, paid API info on Azure required" },
                            { name: "google_safe_browsing", label: "Google Safe Browsing", supports: "risk domain ip", checked: false, title: "Checks Google Safe Browsing, free API key required" },
                            { name: "shodan", label: "Shodan", supports: "ports ip", checked: false, title: "Checks Shodan, reversed obtained IP for a given domain / URL, free API key required" },
                            { name: "phishtank", label: "Phishtank", supports: "risk domain url free_no_key", checked: false, title: "Checks Phishtank for domains, URL, free, no API key" },
                            { name: "threatfox", label: "ThreatFox", supports: "ip domain url free_no_key", checked: false, title: "Checks ThreatFox by Abuse.ch for IP, domains, URL, free, no API key" },
                            { name: "urlscan", label: "URLscan", supports: "domain url ip hash free_no_key", checked: false, title: "Checks URLscan for for IP, domains, URL, hash, free, no API key" },
                            { name: "google", label: "Google", supports: "domain url ip hash extension free_no_key scraping", checked: false, title: "Scraps Google search results for all types of observable, free, no API key" },
                            { name: "github", label: "Github", supports: "domain url ip hash extension free_no_key scraping", checked: false, title: "Get Github grep.app API search results for all types of observable, free, no API key" },
                            { name: "ioc_one_html", label: "Ioc.One (HTML)", supports: "domain url ip hash extension scraping", checked: false, title: "Scraps (can be long) Ioc.One HTML search results for all types of observable, free, no API key" },
                            { name: "ioc_one_pdf", label: "Ioc.One (PDF)", supports: "domain url ip hash extension scraping", checked: false, title: "Scraps (can be long) Ioc.One PDF search results for all types of observable, free, no API key" },
                            { name: "opencti", label: "OpenCTI", supports: "domain url ip hash extension", checked: false, title: "Searches OpenCTI results for all types of observable, API key required" },
                            { name: "abusix", label: "Abusix", supports: "abuse free_no_key", checked: false, title: "Checks abuse contact with Abusix only for IP, reversed obtained IP for a given domain / URL, free, no API key" }
                        ];

                        const enginesToDisplay = GUI_ENABLED_ENGINES.length > 0 ? allEngines.filter(engine => GUI_ENABLED_ENGINES.includes(engine.name)) : allEngines;

                        enginesToDisplay.forEach(engine => {
                            const label = document.createElement('label');
                            label.title = engine.title;
                            const input = document.createElement('input');
                            input.type = 'checkbox';
                            input.name = 'engines';
                            input.value = engine.name;
                            input.dataset.supports = engine.supports;
                            if (engine.checked) {
                                input.checked = true;
                            }
                            label.appendChild(input);
                            label.appendChild(document.createTextNode(` ${engine.label}`));
                            document.querySelector('#analyzeForm div').appendChild(label);
                            document.querySelector('#analyzeForm div').appendChild(document.createElement('br'));
                        });
                        
                        document.querySelector('#analyzeForm div').appendChild(document.createElement('br'));

                    </script>
                </div>

                <div>
                    <div class="radio-container">
                        <input type="radio" id="selectAll" name="engineSelection">
                        <label title="Can be long" for="selectAll" onclick="selectAllEngines()">All</label>
                        <input type="radio" id="selectAbuseChecker" name="engineSelection">
                        <label title="Abuse mail, only IP, domain, URL - All free, no key" for="selectAbuseChecker"
                            onclick="selectAbuseChecker()">Abuse</label>
                        <input type="radio" id="selectHash" name="engineSelection">
                        <label for="selectHash" onclick="selectHash()">Hash</label>
                        <input type="radio" id="selectVpn" name="engineSelection">
                        <label title="Only IP" for="selectVpn" onclick="selectVpn()">VPN / Proxy</label>
                        <input type="radio" id="selectFree" name="engineSelection">
                        <label title="All free engines, no key" for="selectFree" onclick="selectFree()">Free</label>
                        <input type="radio" id="selectExtension" name="engineSelection">
                        <label title="Only Chrome extension" for="selectExtension" onclick="selectExtension()">Extension</label>
                        <input type="radio" id="selectDefault" name="engineSelection" checked>
                        <label title="Good for IP / domain / URL basic info" for="selectDefault"
                            onclick="selectDefault()">Default</label>
                    </div>
                </div>
                <br>

                <script>
                    function selectAllEngines() {
                        document.querySelectorAll('input[name="engines"]').forEach(checkbox => checkbox.checked = true);
                    }

                    function selectAbuseChecker() {
                        document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                            checkbox.checked = checkbox.dataset.supports.includes('abuse');
                        });
                    }

                    function selectHash() {
                        document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                            checkbox.checked = checkbox.dataset.supports.includes('hash');
                        });
                    }

                    function selectVpn() {
                        document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                            checkbox.checked = checkbox.dataset.supports.includes('vpn');
                        });
                    }

                    function selectDefault() {
                        document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                            checkbox.checked = checkbox.dataset.supports.includes('default');
                        });
                    }

                    function selectFree() {
                        document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                            checkbox.checked = checkbox.dataset.supports.includes('free_no_key');
                        });
                    }

                    function selectExtension() {
                        document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                            checkbox.checked = checkbox.dataset.supports.includes('extension');
                        });
                    }
                </script>

                <button type="submit" class="btn" style="position: relative; bottom: 20px;">Start Analysis</button>
            </form>
        </div>

        {% if analysis_results %}
        <script>
            function hideForm() {
                document.getElementById("startForm").style.display = "none";
            }
            hideForm();
        </script>

        <h1>Cyberbro - Analysis Results</h1>

        <button class="btn" onclick="location.href='/'">New Analysis</button>
        <div style="display: flex; gap: 10px; margin-left: 0;">
            <form method="GET" action="/export/{{ analysis_results.id }}"
                style="display: flex; gap: 10px; margin-left: 0;">
                <button type="submit" name="format" value="csv" class="btn">Export to CSV</button>
                <button type="submit" name="format" value="excel" class="btn">Export to Excel</button>
            </form>
            <button class="btn" onclick="location.href='/{{ API_PREFIX }}/results/{{ analysis_results.id }}'">Raw</button>
            <button class="btn" onclick="copyAsPlainText()">Copy as Plain Text</button>
        </div>

        <script>
            function copyAsPlainText() {
                fetch(`/{{ API_PREFIX }}/results/{{ analysis_results.id }}`)
                    .then(response => response.json())
                    .then(data => {
                        let plainText = '';
                        data.forEach(result => {
                            plainText += `Observable: ${result.observable}\nType: ${result.type}\n`;

                            if (result.extension) {
                                plainText += `Extension: ${result.extension.name}\n`;
                                plainText += `URL: ${result.extension.url}\n`;
                            }

                            if (result.reverse_dns) {
                                plainText += `Reverse DNS: ${result.reverse_dns.reverse_dns.join(', ')}\n`;
                            }
                            if (result.ipquery) {
                                plainText += `IPquery: Geolocation: ${result.ipquery.geolocation}, Country: ${result.ipquery.country_name}, ASN: ${result.ipquery.asn}, Risk Score: ${result.ipquery.risk_score}, Proxy: ${result.ipquery.is_proxy}, Tor: ${result.ipquery.is_tor}, VPN: ${result.ipquery.is_vpn}\n`;
                            }
                            if (result.ipinfo) {
                                plainText += `IPinfo: Geolocation: ${result.ipinfo.geolocation}, Country: ${result.ipinfo.country_name}, ASN: ${result.ipinfo.asn}\n`;
                            }
                            if (result.abuseipdb) {
                                plainText += `AbuseIPDB: Reports: ${result.abuseipdb.reports}, Risk Score: ${result.abuseipdb.risk_score}\n`;
                            }
                            if (result.spur) {
                                plainText += `Spur: Tunnels: ${result.spur.tunnels}\n`;
                            }
                            if (result.virustotal) {
                                plainText += `VirusTotal: Detection Ratio: ${result.virustotal.detection_ratio}, Community Score: ${result.virustotal.community_score}\n`;
                            }
                            if (result.mde) {
                                plainText += `Microsoft Defender for Endpoint: Prevalence: ${result.mde.organizationPrevalence}, First Seen: ${result.mde.orgFirstSeen}, Last Seen: ${result.mde.orgLastSeen}\n`;
                            }
                            if (result.google_safe_browsing) {
                                plainText += `Google Safe Browsing: ${result.google_safe_browsing.threat_found}\n`;
                            }
                            if (result.shodan) {
                                plainText += `Shodan: Ports: ${result.shodan.ports.join(', ')}${result.shodan.tags.length > 0 ? `, Tags: ${result.shodan.tags.join(', ')}` : ''}\n`;
                            }
                            if (result.phishtank) {
                                plainText += `Phishtank: In Database: ${result.phishtank.in_database}\n`;
                            }
                            if (result.abusix) {
                                plainText += `Abusix: ${result.abusix.abuse}\n`;
                            }
                            if (result.rdap) {
                                plainText += `RDAP: Registrar: ${result.rdap.registrar}, Abuse Contact: ${result.rdap.abuse_contact}, Registrant: ${result.rdap.registrant}, Organization: ${result.rdap.organization}, Registrant Email: ${result.rdap.registrant_email}, Creation Date: ${result.rdap.creation_date}, Expiration Date: ${result.rdap.expiration_date}, Updated Date: ${result.rdap.update_date}, Name Servers: ${result.rdap.name_servers.join(', ')}\n`;
                            }
                            if (result.threatfox && result.threatfox.count > 0) {
                                plainText += `ThreatFox: Count: ${result.threatfox.count}, Malware: ${result.threatfox.malware_printable.join(', ')}\n`;
                            }
                            if (result.google && result.google.results.length > 0) {
                                plainText += `Google:\n`;
                                result.google.results.forEach(googleResult => {
                                    plainText += `  - ${googleResult.title}: ${googleResult.url}\n`;
                                });
                            }
                            if (result.github && result.github.results.length > 0) {
                                plainText += `Github:\n`;
                                result.github.results.forEach(githubResult => {
                                    plainText += `  - ${githubResult.title}: ${githubResult.url}\n`;
                                });
                            }
                            if (result.ioc_one_html && result.ioc_one_html.results.length > 0) {
                                plainText += `Ioc.One (HTML):\n`;
                                result.ioc_one_html.results.forEach(iocOneHtmlResult => {
                                    plainText += `  - ${iocOneHtmlResult.title}: ${iocOneHtmlResult.source}\n`;
                                });
                            }
                            if (result.ioc_one_pdf && result.ioc_one_pdf.results.length > 0) {
                                plainText += `Ioc.One (PDF):\n`;
                                result.ioc_one_pdf.results.forEach(iocOnePdfResult => {
                                    plainText += `  - ${iocOnePdfResult.title}: ${iocOnePdfResult.source}\n`;
                                });
                            }
                            if (result.urlscan && result.urlscan.scan_count > 0) {
                                plainText += `URLscan: Scan Count: ${result.urlscan.scan_count}\n`;
                                result.urlscan.top_domains.forEach(domain => {
                                    plainText += `  - ${domain.domain} (${domain.count})\n`;
                                });
                            }
                            if (result.opencti && result.opencti.global_count > 0) {
                                plainText += `OpenCTI:\n`;
                                plainText += `  - Global Count: ${result.opencti.global_count}\n`;
                                plainText += `  - Entity Counts:\n`;
                                for (const [entity, count] of Object.entries(result.opencti.entity_counts)) {
                                    plainText += `    - ${entity}: ${count}\n`;
                                }
                                plainText += `  - Search Link: ${result.opencti.search_link}\n`;
                                plainText += `  - Latest Entity Created At: ${result.opencti.latest_created_at}\n`;
                                plainText += `  - Latest Indicator Name: ${result.opencti.latest_indicator_name}\n`;
                                if (result.opencti.latest_indicator_link) {
                                    plainText += `  - Latest Indicator Link: ${result.opencti.latest_indicator_link}\n`;
                                    plainText += `  - OpenCTI Score: ${result.opencti.x_opencti_score} / 100\n`;
                                    plainText += `  - Confidence: ${result.opencti.confidence}\n`;
                                    plainText += `  - Revoked: ${result.opencti.revoked}\n`;
                                    plainText += `  - Valid From: ${result.opencti.valid_from}\n`;
                                    plainText += `  - Valid Until: ${result.opencti.valid_until}\n`;
                                }
                            }
                            plainText += '\n';
                        });

                        navigator.clipboard.writeText(plainText).then(() => {
                            const copyButton = document.querySelector('.btn[onclick="copyAsPlainText()"]');
                            copyButton.style.backgroundColor = 'green';
                            copyButton.textContent = 'Copied!';
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                        });
                    })
                    .catch(err => {
                        console.error('Failed to fetch results: ', err);
                    });
            }
        </script>

        <p>Analysis start time: {{ analysis_results.start_time_string }}</p>
        <p>Analysis duration: {{ analysis_results.analysis_duration_string }}</p>

        {% if analysis_results.results | length > 1 %}

        <div class="filters-container">
            <input type="text" id="searchInput" class="filter-input" onkeyup="filterTable()" placeholder="Search...">

            <select id="typeFilter" class="filter-select" onchange="filterTable()">
                <option value="all">All observables types</option>
                {% set types = [] %}
                {% for result in analysis_results.results %}
                {% if result.type not in types %}
                {% set _ = types.append(result.type) %}
                <option value="{{ result.type }}">{{ result.type }}</option>
                {% endif %}
                {% endfor %}
            </select>

            <select id="countryFilter" class="filter-select" onchange="filterTable()">
                <option value="all">All Countries</option>
                {% set countries = [] %}
                {% for result in analysis_results.results %}
                {% if (result.ipinfo and result.ipinfo.country_name not in countries) or (result.ipquery and
                result.ipquery.country_name not in countries) %}
                {% if result.ipinfo and result.ipinfo.country_name not in countries %}
                {% set _ = countries.append(result.ipinfo.country_name) %}
                <option value="{{ result.ipinfo.country_name | lower }}">{{ result.ipinfo.country_name }}</option>
                {% endif %}
                {% if result.ipquery and result.ipquery.country_name not in countries %}
                {% set _ = countries.append(result.ipquery.country_name) %}
                <option value="{{ result.ipquery.country_name | lower }}">{{ result.ipquery.country_name }}</option>
                {% endif %}
                {% endif %}
                {% endfor %}
            </select>

            <select id="riskFilter" class="filter-select" onchange="filterTable()">
                <option value="all">All Risks</option>
                <option value="high">High Risk</option>
                <option value="low">Low Risk</option>
            </select>

            <select id="detectionFilter" class="filter-select" onchange="filterTable()">
                <option value="all">All Detections</option>
                <option value="high">High Detection</option>
                <option value="clean">Clean Detection</option>
            </select>

            <select id="proxyVpnFilter" class="filter-select" onchange="filterTable()">
                <option value="all">All connection info</option>
                <option value="proxy">Proxy</option>
                <option value="vpn">VPN</option>
                <option value="not anonymous">Not anonymous</option>
            </select>

            <button class="btn" onclick="clearFilters()">Clear Filters</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Observable</th>
                    <th>Type</th>
                    {% if "reverse_dns" in analysis_results.selected_engines %}
                    <th>DNS Lookup</th>
                    {% endif %}
                    {% if "CHROME_EXTENSION" in analysis_results.results | map(attribute='type') %}
                    <th>Extension</th>
                    {% endif %}
                    {% if "ipquery" in analysis_results.selected_engines %}
                    <th>IPquery</th>
                    {% endif %}
                    {% if "ipinfo" in analysis_results.selected_engines %}
                    <th>IPinfo</th>
                    {% endif %}
                    {% if "abuseipdb" in analysis_results.selected_engines %}
                    <th>AbuseIPDB</th>
                    {% endif %}
                    {% if "spur" in analysis_results.selected_engines %}
                    <th>Spur.us</th>
                    {% endif %}
                    {% if "virustotal" in analysis_results.selected_engines %}
                    <th>VirusTotal</th>
                    {% endif %}
                    {% if "mde" in analysis_results.selected_engines %}
                    <th>Microsoft Defender for Endpoint</th>
                    {% endif %}
                    {% if "google_safe_browsing" in analysis_results.selected_engines %}
                    <th>Google Safe Browsing</th>
                    {% endif %}
                    {% if "shodan" in analysis_results.selected_engines %}
                    <th>Shodan</th>
                    {% endif %}
                    {% if "phishtank" in analysis_results.selected_engines %}
                    <th>Phishtank</th>
                    {% endif %}
                    {% if "abusix" in analysis_results.selected_engines %}
                    <th>Abusix</th>
                    {% endif %}
                    {% if "rdap" in analysis_results.selected_engines %}
                    <th>RDAP</th>
                    {% endif %}
                    {% if "threatfox" in analysis_results.selected_engines %}
                    <th>ThreatFox</th>
                    {% endif %}
                    {% if "google" in analysis_results.selected_engines %}
                    <th>Google</th>
                    {% endif %}
                    {% if "github" in analysis_results.selected_engines %}
                    <th>Github</th>
                    {% endif %}
                    {% if "ioc_one_html" in analysis_results.selected_engines %}
                    <th>Ioc.One (HTML)</th>
                    {% endif %}
                    {% if "ioc_one_pdf" in analysis_results.selected_engines %}
                    <th>Ioc.One (PDF)</th>
                    {% endif %}
                    {% if "urlscan" in analysis_results.selected_engines %}
                    <th>URLscan</th>
                    {% endif %}
                    {% if "opencti" in analysis_results.selected_engines %}
                    <th>OpenCTI</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for result in analysis_results.results %}
                <tr class="
                    {% if result.abuseipdb and result.abuseipdb.risk_score > 50 %}
                        high-risk
                    {% elif result.virustotal and (result.virustotal.total_malicious > 10 or result.virustotal.community_score < -10) %}
                        high-detection
                    {% elif result.virustotal and result.virustotal.community_score > 100 %}
                        clean-detection
                    {% elif result.spur and result.spur.tunnels not in ['Not anonymous', 'Non applicable'] %}
                        warning-row
                    {% elif result.ipquery and (result.ipquery.is_proxy or result.ipquery.is_vpn or result.ipquery.is_tor) %}
                        warning-row
                    {% elif result.ipquery and result.ipquery.risk_score > 50 %}
                        high-risk
                    {% elif result.threatfox and result.threatfox.count != 0 %}
                        high-risk
                    {% elif result.opencti and result.opencti.latest_indicator_link and not result.opencti.revoked %}
                        warning-row
                    {% endif %}
                    ">
                    <td title="{{ result.observable }}">{{ result.observable[:64] }}{% if result.observable | length >
                        64 %}...{% endif %}</td>
                    <td>{{ result.type }}</td>
                    {% if "reverse_dns" in analysis_results.selected_engines %}
                    <td>
                        {% if result.reverse_dns %}
                        {% for dns in result.reverse_dns.reverse_dns %}
                        {{ dns }}<br>
                        {% endfor %}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "CHROME_EXTENSION" in analysis_results.results | map(attribute='type') %}
                    <td>
                        {% if result.type == "CHROME_EXTENSION" %}
                        <a href="{{ result.extension.url }}" target="_blank">{{ result.extension.name }}</a>
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "ipquery" in analysis_results.selected_engines %}
                    <td>
                        {% if result.ipquery %}
                        <strong>IP: </strong><a href="{{ result.ipquery.link }}" target="_blank">{{ result.ipquery.ip
                            }}</a><br>
                        <strong>Score: </strong><a href="{{ result.ipquery.link }}" target="_blank">{{
                            result.ipquery.risk_score }}</a><br>

                        <strong>Geoloc: </strong>{{ result.ipquery.geolocation }}<br>
                        <strong>Country: </strong><span
                            class="country country-{{result.ipquery.country_name | lower}}">{{result.ipquery.country_name}}</span>
                        <span class="fi fi-{{ result.ipquery.country_code | lower }}"></span><br>
                        <strong>ASN: </strong>{{ result.ipquery.asn }} {{ result.ipquery.isp }}<br>
                        {% if result.ipquery.is_proxy == True %}
                        <strong>Proxy: </strong>{{ result.ipquery.is_proxy }}<br>
                        {% endif %}

                        {% if result.ipquery.is_vpn == True %}
                        <strong>VPN: </strong>{{ result.ipquery.is_vpn }}<br>
                        {% endif %}
                        {% if result.ipquery.is_tor == True %}
                        <strong>Tor: </strong>{{ result.ipquery.is_tor }}<br>
                        {% endif %}
                        {% if result.ipquery.is_tor == False and result.ipquery.is_vpn == False and
                        result.ipquery.is_proxy == False %}
                        <strong>Type: </strong>Not anonymous<br>
                        {% endif %}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "ipinfo" in analysis_results.selected_engines %}
                    <td>
                        {% if result.ipinfo and result.reversed_success and result.type in ["URL", "FQDN"] %}
                        Reverse DNS applied<br>
                        {% endif %}
                        {% if result.ipinfo %}
                        <strong>IP: </strong><a href="{{ result.ipinfo.link }}" target="_blank">{{ result.ipinfo.ip
                            }}</a><br>
                        <strong>Geoloc: </strong>{{ result.ipinfo.geolocation }}<br>
                        <strong>Country: </strong><span
                            class="country country-{{result.ipinfo.country_name | lower}}">{{result.ipinfo.country_name}}</span>
                        <span class="fi fi-{{ result.ipinfo.country_code | lower }}"></span><br>
                        <strong>Hostname: </strong>{{ result.ipinfo.hostname }}<br>
                        <strong>ASN: </strong>{{ result.ipinfo.asn }}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "abuseipdb" in analysis_results.selected_engines %}
                    <td>
                        {% if result.abuseipdb and result.reversed_success and result.type in ["URL", "FQDN"] %}
                        Reverse DNS applied<br>
                        {% endif %}
                        {% if result.abuseipdb %}
                        <strong>Reports: </strong>
                        <a href="{{ result.abuseipdb.link }}" target="_blank">{{ result.abuseipdb.reports }}</a><br>
                        <strong>Risk: </strong>{{ result.abuseipdb.risk_score }}%<br>
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "spur" in analysis_results.selected_engines %}
                    <td>
                        {% if result.spur and result.reversed_success and result.type in ["URL", "FQDN"] %}
                        Reverse DNS applied<br>
                        {% endif %}
                        {% if result.spur %}
                        <a href="{{ result.spur.link }}" target="_blank">{{ result.spur.tunnels }}</a><br>
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "virustotal" in analysis_results.selected_engines %}
                    <td>
                        {% if result.virustotal %}
                        <strong>Ratio: </strong>
                        <a href="{{ result.virustotal.link }}" target="_blank">{{ result.virustotal.detection_ratio
                            }}</a><br>
                        <strong>Community: </strong>{{ result.virustotal.community_score }}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "mde" in analysis_results.selected_engines %}
                    <td>
                        {% if result.mde and result.mde.ipAddress %}
                        <strong>Devices: </strong><a href="{{ result.mde.link }}" target="_blank">{{
                            result.mde.orgPrevalence }}</a><br>
                        <strong>First seen: </strong>{{ result.mde.orgFirstSeen }} <br>
                        <strong>Last seen: </strong>{{ result.mde.orgLastSeen }} <br>
                        {% elif result.mde and result.mde.sha1 %}
                        <strong>Devices: </strong><a href="{{ result.mde.link }}" target="_blank">{{
                            result.mde.organizationPrevalence }}</a><br>
                        <strong>First seen: </strong>{{ result.mde.orgFirstSeen }} <br>
                        <strong>Last seen: </strong>{{ result.mde.orgLastSeen }} <br>
                        <strong>Top filenames: </strong>{{ result.mde.topFileNames }} <br>
                        <strong>File product name: </strong>{{ result.mde.fileProductName }} <br>
                        <strong>File publisher: </strong>{{ result.mde.filePublisher }} <br>
                        <strong>Signer : </strong>{{ result.mde.signer }} <br>
                        <strong>Issuer: </strong>{{ result.mde.issuer }} <br>
                        <strong>IsValidCertificate: </strong>{{ result.mde.isValidCertificate }} <br>
                        <strong>Determination: </strong>{{ result.mde.determinationType }} <br>
                        <strong>Determination value: </strong>{{ result.mde.determinationValue }}
                        {% elif result.mde and result.mde.host %}
                        </strong>Devices: </strong><a href="{{ result.mde.link }}" target="_blank">{{
                            result.mde.orgPrevalence }}</a><br>
                        </strong>First seen: </strong>{{ result.mde.orgFirstSeen }} <br>
                        </strong>Last seen: </strong>{{ result.mde.orgLastSeen }} <br>
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "google_safe_browsing" in analysis_results.selected_engines %}
                    <td>
                        {% if result.google_safe_browsing %}
                        <strong>Threat: </strong>{{ result.google_safe_browsing.threat_found }} <br>
                        <strong>Details: </strong>{{ result.google_safe_browsing.details }}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "shodan" in analysis_results.selected_engines %}
                    <td>
                        {% if result.shodan %}
                        <strong>Ports:</strong><br>
                        <a href="{{ result.shodan.link }}" target="_blank">
                            {% for port in result.shodan.ports %}
                            {{ port }}<br>
                            {% endfor %}
                        </a>
                        {% if result.shodan.tags | length > 0 %}
                        <strong>Tags: </strong>
                        {% for tag in result.shodan.tags %}
                        {{ tag | upper }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% endif %}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "phishtank" in analysis_results.selected_engines %}
                    <td>
                        {% if result.phishtank and result.phishtank.in_database == True and result.phishtank.valid ==
                        True and result.phishtank.verified == True %}
                        <a href="{{ result.phishtank.phish_detail_page }}" target="_blank">Found (valid and
                            verified)</a>
                        {% elif result.phishtank and result.phishtank.in_database == True and result.phishtank.valid ==
                        False %}
                        <a href="{{ result.phishtank.phish_detail_page }}" target="_blank">Found (invalid)</a>
                        {% elif result.phishtank and result.phishtank.in_database == True and result.phishtank.verified
                        == False %}
                        <a href="{{ result.phishtank.phish_detail_page }}" target="_blank">Found (not verified)</a>
                        {% elif result.phishtank and result.phishtank.in_database == False %}
                        Not Found
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "abusix" in analysis_results.selected_engines %}
                    <td>
                        {% if result.abusix %}
                        <strong>Abuse contact: </strong><a
                            href="mailto:{{ result.abusix.abuse }}?subject=Report of abuse concerning {{ result.observable }}&body=Hello,%0D%0A%0D%0AOur team found out that your {{ result.type }} {{ result.observable }} does malicious activity.%0D%0A%0D%0APlease take actions.">{{
                            result.abusix.abuse }}</a>
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "rdap" in analysis_results.selected_engines %}
                    <td>
                        {% if result.rdap %}
                        <strong>Registrar: </strong><a href="{{ result.rdap.link }}" target="_blank">{{
                            result.rdap.registrar }}</a><br>
                        {% if result.rdap.abuse_contact and result.rdap.abuse_contact != "" %}
                        <strong>Abuse contact: </strong><a
                            href="mailto:{{ result.rdap.abuse_contact }}?subject=Report of abuse concerning {{ result.observable }}&body=Hello,%0D%0A%0D%0AOur team found out that your {{ result.type }} {{ result.observable }} does malicious activity.%0D%0A%0D%0APlease take actions.">{{
                            result.rdap.abuse_contact }}</a><br>
                        {% endif %}
                        {% if result.rdap.registrant and result.rdap.registrant != "" %}
                        <strong>Registrant: </strong> {{ result.rdap.registrant }}<br>
                        {% endif %}
                        {% if result.rdap.organization and result.rdap.organization != "" %}
                        <strong>Organization: </strong>{{ result.rdap.organization }}<br>
                        {% endif %}
                        {% if result.rdap.registrant_email and result.rdap.registrant_email != "" %}
                        <strong>Registrant email: </strong><a
                            href="mailto:{{ result.rdap.registrant_email }}?subject=Report of abuse concerning {{ result.observable }}&body=Hello,%0D%0A%0D%0AOur team found out that your {{ result.type }} {{ result.observable }} does malicious activity.%0D%0A%0D%0APlease take actions.">{{
                            result.rdap.registrant_email }}</a><br>
                        {% endif %}
                        <strong>Creation: </strong>{{ result.rdap.creation_date }}<br>
                        <strong>Expiration: </strong>{{ result.rdap.expiration_date }}<br>
                        <strong>Updated: </strong>{{ result.rdap.update_date }}<br>
                        <strong>Name servers: </strong><br>
                        {% for ns in result.rdap.name_servers %}
                        {{ ns }}<br>
                        {% endfor %}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "threatfox" in analysis_results.selected_engines %}
                    <td>
                        {% if result.threatfox and result.threatfox.count != 0 %}
                        <strong>Count: </strong><a href="{{ result.threatfox.link }}" target="_blank"
                            title="Might not be available in the website itself.">{{ result.threatfox.count }}</a><br>
                        <strong>Malware: </strong><br>
                        {% for malware in result.threatfox.malware_printable %}
                        {{ malware }}<br>
                        {% endfor %}
                        {% elif result.threatfox and result.threatfox.count == 0 %}
                        Not Found
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "google" in analysis_results.selected_engines %}
                    <td>
                        {% if result.google and result.google.results | length > 0 %}
                        <strong>Search results: </strong><br>
                        {% for search_result in result.google.results %}
                        <a href="{{ search_result.url }}" target="_blank" title="{{ search_result.description }}">{{
                            search_result.title }}</a><br>
                        {% endfor %}
                        {% elif result.google and result.google.results | length == 0 %}
                        Not Found
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "github" in analysis_results.selected_engines %}
                    <td>
                        {% if result.github and result.github.results | length > 0 %}
                        <strong>Search results: </strong><br>
                        {% for search_result in result.github.results %}
                        <a href="{{ search_result.url }}" target="_blank" title="{{ search_result.description }}">{{
                            search_result.title }}</a><br>
                        {% endfor %}
                        {% elif result.github and result.github.results | length == 0 %}
                        Not Found
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "ioc_one_html" in analysis_results.selected_engines %}
                    <td>
                        {% if result.ioc_one_html and result.ioc_one_html.results | length > 0 %}
                        <strong>Search results: </strong><a href="{{ result.ioc_one_html.link }}" target="_blank">See on
                            Ioc.One</a><br>
                        ---<br>
                        {% for search_result in result.ioc_one_html.results %}
                        <a href="{{ search_result.source }}" target="_blank" title="{{ search_result.header }}">{{
                            search_result.title }}</a><br>
                        {% endfor %}
                        {% elif result.ioc_one_html and result.ioc_one_html.results | length == 0 %}
                        Not Found
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "ioc_one_pdf" in analysis_results.selected_engines %}
                    <td>
                        {% if result.ioc_one_pdf and result.ioc_one_pdf.results | length > 0 %}
                        <strong>Search results: </strong><a href="{{ result.ioc_one_pdf.link }}" target="_blank">See on
                            Ioc.One</a><br>
                        ---<br>
                        {% for search_result in result.ioc_one_pdf.results %}
                        <a href="{{ search_result.source }}" target="_blank" title="{{ search_result.header }}">{{
                            search_result.title }}</a><br>
                        {% endfor %}
                        {% elif result.ioc_one_pdf and result.ioc_one_pdf.results | length == 0 %}
                        Not Found
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "urlscan" in analysis_results.selected_engines %}
                    <td>
                        {% if result.urlscan %}
                        <strong>Scan count: </strong><a href="{{ result.urlscan.link }}" target="_blank">{{
                            result.urlscan.scan_count }}</a><br>
                        {% if result.urlscan.scan_count == 0 %}
                        Not Found
                        {% else %}
                        <strong>
                            {% if result.type in ["FQDN", "URL"] %}
                            Top domains:
                            {% else %}
                            Top related domains:
                            {% endif %}
                        </strong>
                        <ul>
                            {% for domain in result.urlscan.top_domains %}
                            <li>{{ domain.domain }} ({{ domain.count }})</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if "opencti" in analysis_results.selected_engines %}
                    <td>
                        {% if result.opencti %}
                        <strong>Global count: </strong>{{ result.opencti.global_count }}<br>
                        <strong>Entity counts:</strong>
                        <ul>
                            {% for entity, count in result.opencti.entity_counts.items() %}
                            <li>{{ entity }}: {{ count }}</li>
                            {% endfor %}
                        </ul>
                        <strong>Search link: </strong><a href="{{ result.opencti.search_link }}" target="_blank">See on OpenCTI</a><br>
                        <strong>Latest Entity Created At: </strong>{{ result.opencti.latest_created_at }}<br>
                        {% if result.opencti.latest_indicator_link %}
                            <strong>Latest Indicator Name: </strong>{{ result.opencti.latest_indicator_name }}<br>
                            <strong>Latest Indicator Link: </strong><a href="{{ result.opencti.latest_indicator_link }}" target="_blank">See Indicator</a><br>
                            <strong>OpenCTI Score: </strong>{{ result.opencti.x_opencti_score }} / 100<br>
                            <strong>Confidence: </strong>{{ result.opencti.confidence }}<br>
                            <strong>Revoked: </strong>{{ result.opencti.revoked }}<br>
                            <strong>Valid From: </strong>{{ result.opencti.valid_from }}<br>
                            <strong>Valid Until: </strong>{{ result.opencti.valid_until }}<br>
                        {% endif %}
                        {% else %}
                        Not applicable
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% elif analysis_results.results | length == 1 %}

        <div class="cards-container">
            <div class="cards-results-container">
                <div class="card">
                    <h3 title="{{ analysis_results.results[0].observable }}">{{
                        analysis_results.results[0].observable[:64] }}{% if analysis_results.results[0].observable |
                        length > 80 %}...{% endif %}</h3>
                    <p>{{ analysis_results.results[0].type }}</p>
                </div>
                {% if analysis_results.results[0].reverse_dns and analysis_results.results[0].reverse_dns.reverse_dns %}
                <div class="card">
                    <h3>DNS Lookup</h3>
                    <p>{{ analysis_results.results[0].reverse_dns.reverse_dns | join(', ') }}</p>
                </div>
                {% endif %}
                {% if analysis_results.results[0].virustotal %}
                <div class="card
                {% if analysis_results.results[0].virustotal and (analysis_results.results[0].virustotal.total_malicious > 10 or analysis_results.results[0].virustotal.community_score < -10) %}
                 high-detection" style="background-color: red;" {% elif analysis_results.results[0].virustotal and
                    analysis_results.results[0].virustotal.community_score> 100 %}
                    clean-detection" style="background-color: green;"
                    {% else %}
                    "
                    {% endif %}
                    >
                    <h3>VirusTotal</h3>
                    <p><strong>Ratio: </strong><a href="{{ analysis_results.results[0].virustotal.link }}"
                            target="_blank">{{ analysis_results.results[0].virustotal.detection_ratio }}</a></p>
                    <p><strong>Community: </strong>{{ analysis_results.results[0].virustotal.community_score }}</p>
                </div>
                {% endif %}
                {% if analysis_results.results[0].extension %}
                <div class="card">
                    <h3>Extension</h3>
                    {% if analysis_results.results[0].extension.url %}
                    <p><a href="{{ analysis_results.results[0].extension.url }}"
                            target="_blank">{{ analysis_results.results[0].extension.name }}</a></p>
                    {% else %}
                    <p>Not Found</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="cards-results-container">
                {% if analysis_results.results[0].rdap %}
                <div class="card">
                    <h3>RDAP</h3>
                    <p><strong>Registrar: </strong><a href="{{ analysis_results.results[0].rdap.link }}"
                            target="_blank">{{ analysis_results.results[0].rdap.registrar }}</a></p>
                    {% if analysis_results.results[0].rdap.abuse_contact %}
                    <p><strong>Abuse contact: </strong><a
                            href="mailto:{{ analysis_results.results[0].rdap.abuse_contact }}?subject=Report of abuse concerning {{ analysis_results.results[0].observable }}&body=Hello,%0D%0A%0D%0AOur team found out that your {{ analysis_results.results[0].type }} {{ analysis_results.results[0].observable }} does malicious activity.%0D%0A%0D%0APlease take actions.">{{
                            analysis_results.results[0].rdap.abuse_contact }}</a></p>
                    {% endif %}
                    {% if analysis_results.results[0].rdap.registrant %}
                    <p><strong>Registrant: </strong>{{ analysis_results.results[0].rdap.registrant }}</p>
                    {% endif %}
                    {% if analysis_results.results[0].rdap.organization %}
                    <p><strong>Organization: </strong>{{ analysis_results.results[0].rdap.organization }}</p>
                    {% endif %}
                    {% if analysis_results.results[0].rdap.registrant_email %}
                    <p><strong>Registrant email: </strong><a
                            href="mailto:{{ analysis_results.results[0].rdap.registrant_email }}?subject=Report of abuse concerning {{ analysis_results.results[0].observable }}&body=Hello,%0D%0A%0D%0AOur team found out that your {{ analysis_results.results[0].type }} {{ analysis_results.results[0].observable }} does malicious activity.%0D%0A%0D%0APlease take actions.">{{
                            analysis_results.results[0].rdap.registrant_email }}</a></p>
                    {% endif %}
                    <p><strong>Creation: </strong>{{ analysis_results.results[0].rdap.creation_date }}</p>
                    <p><strong>Expiration: </strong>{{ analysis_results.results[0].rdap.expiration_date }}</p>
                    <p><strong>Updated: </strong>{{ analysis_results.results[0].rdap.update_date }}</p>
                    <p><strong>Name servers: </strong>{{ analysis_results.results[0].rdap.name_servers | join(', ') }}
                    </p>
                </div>
                {% endif %}
                {% if analysis_results.results[0].ipquery %}
                <div class="card
                {% if analysis_results.results[0].ipquery and (analysis_results.results[0].ipquery.is_proxy or analysis_results.results[0].ipquery.is_vpn or analysis_results.results[0].ipquery.is_tor) %}
                 warning-row" style="background-color: orange;" {% elif analysis_results.results[0].ipquery and
                    analysis_results.results[0].ipquery.risk_score> 50 %}
                    high-risk" style="background-color: red;"
                    {% else %}
                    "
                    {% endif %}
                    >
                    <h3>IPquery</h3>
                    <p><strong>IP: </strong><a href="{{ analysis_results.results[0].ipquery.link }}" target="_blank">{{
                            analysis_results.results[0].ipquery.ip }}</a></p>
                    <p><strong>Score: </strong>{{ analysis_results.results[0].ipquery.risk_score }}</p>
                    <p><strong>Geoloc: </strong>{{ analysis_results.results[0].ipquery.geolocation }}</p>
                    <p><strong>Country: </strong>{{ analysis_results.results[0].ipquery.country_name }} <span
                            class="fi fi-{{ analysis_results.results[0].ipquery.country_code | lower }}"></span></p>
                    <p><strong>ASN: </strong>{{ analysis_results.results[0].ipquery.asn }} {{
                        analysis_results.results[0].ipquery.isp }}</p>
                    {% if analysis_results.results[0].ipquery.is_proxy %}
                    <p><strong>Proxy: </strong>{{ analysis_results.results[0].ipquery.is_proxy }}</p>
                    {% endif %}
                    {% if analysis_results.results[0].ipquery.is_vpn %}
                    <p><strong>VPN: </strong>{{ analysis_results.results[0].ipquery.is_vpn }}</p>
                    {% endif %}
                    {% if analysis_results.results[0].ipquery.is_tor %}
                    <p><strong>Tor: </strong>{{ analysis_results.results[0].ipquery.is_tor }}</p>
                    {% endif %}
                    {% if not analysis_results.results[0].ipquery.is_tor and not
                    analysis_results.results[0].ipquery.is_vpn and not analysis_results.results[0].ipquery.is_proxy %}
                    <p><strong>Type: </strong>Not anonymous</p>
                    {% endif %}
                </div>
                {% endif %}
                {% if analysis_results.results[0].ipinfo %}
                <div class="card">
                    <h3>IPinfo</h3>
                    <p><strong>IP: </strong><a href="{{ analysis_results.results[0].ipinfo.link }}" target="_blank">{{
                            analysis_results.results[0].ipinfo.ip }}</a></p>
                    <p><strong>Geoloc: </strong>{{ analysis_results.results[0].ipinfo.geolocation }}</p>
                    <p><strong>Country: </strong>{{ analysis_results.results[0].ipinfo.country_name }} <span
                            class="fi fi-{{ analysis_results.results[0].ipinfo.country_code | lower }}"></span></p>
                    <p><strong>Hostname: </strong>{{ analysis_results.results[0].ipinfo.hostname }}</p>
                    <p><strong>ASN: </strong>{{ analysis_results.results[0].ipinfo.asn }}</p>
                </div>
                {% endif %}
                {% if analysis_results.results[0].abusix %}
                <div class="card">
                    <h3>Abusix</h3>
                    <p><strong>Abuse contact: </strong><a
                            href="mailto:{{ analysis_results.results[0].abusix.abuse }}?subject=Report of abuse concerning {{ analysis_results.results[0].observable }}&body=Hello,%0D%0A%0D%0AOur team found out that your {{ analysis_results.results[0].type }} {{ analysis_results.results[0].observable }} does malicious activity.%0D%0A%0D%0APlease take actions.">{{
                            analysis_results.results[0].abusix.abuse }}</a></p>
                </div>
                {% endif %}
            </div>
            <div class="cards-results-container">
                {% if analysis_results.results[0].abuseipdb %}
                <div class="card{% if analysis_results.results[0].abuseipdb and analysis_results.results[0].abuseipdb.risk_score > 50 %} high-risk"
                    style="background-color: red;" {% else %}"{% endif %}>
                    <h3>AbuseIPDB</h3>
                    <p><strong>Reports: </strong><a href="{{ analysis_results.results[0].abuseipdb.link }}"
                            target="_blank">{{ analysis_results.results[0].abuseipdb.reports }}</a></p>
                    <p><strong>Risk: </strong>{{ analysis_results.results[0].abuseipdb.risk_score }}%</p>
                </div>
                {% endif %}
                {% if analysis_results.results[0].spur %}
                <div class="card{% if analysis_results.results[0].spur and analysis_results.results[0].spur.tunnels not in ['Not anonymous', 'Non applicable'] %} warning-row"
                    style="background-color: orange;" {% else %}"{% endif %}>
                    <h3>Spur.us</h3>
                    <p><a href="{{ analysis_results.results[0].spur.link }}" target="_blank">{{
                            analysis_results.results[0].spur.tunnels }}</a></p>
                </div>
                {% endif %}
            </div>

            <div class="cards-results-container">
                {% if analysis_results.results[0].urlscan %}
                <div class="card">
                    <h3>URLscan</h3>
                    <p><strong>Scan count: </strong><a href="{{ analysis_results.results[0].urlscan.link }}"
                            target="_blank">{{ analysis_results.results[0].urlscan.scan_count }}</a></p>
                    {% if analysis_results.results[0].urlscan.scan_count == 0 %}
                    <p>Not Found</p>
                    {% else %}
                    <p><strong>
                            {% if analysis_results.results[0].type in ["FQDN", "URL"] %}
                            Top domains:
                            {% else %}
                            Top related domains:
                            {% endif %}
                        </strong></p>
                    <ul>
                        {% for domain in analysis_results.results[0].urlscan.top_domains %}
                        <li>{{ domain.domain }} ({{ domain.count }})</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                {% endif %}
            </div>

            <div class="cards-results-container">
                {% if analysis_results.results[0].mde %}
                <div class="card">
                    <h3>Microsoft Defender for Endpoint</h3>
                    {% if analysis_results.results[0].mde.ipAddress %}
                    <p><strong>Devices: </strong><a href="{{ analysis_results.results[0].mde.link }}" target="_blank">{{
                            analysis_results.results[0].mde.orgPrevalence }}</a></p>
                    <p><strong>First seen: </strong>{{ analysis_results.results[0].mde.orgFirstSeen }}</p>
                    <p><strong>Last seen: </strong>{{ analysis_results.results[0].mde.orgLastSeen }}</p>
                    {% elif analysis_results.results[0].mde.sha1 %}
                    <p><strong>Devices: </strong><a href="{{ analysis_results.results[0].mde.link }}" target="_blank">{{
                            analysis_results.results[0].mde.organizationPrevalence }}</a></p>
                    <p><strong>First seen: </strong>{{ analysis_results.results[0].mde.orgFirstSeen }}</p>
                    <p><strong>Last seen: </strong>{{ analysis_results.results[0].mde.orgLastSeen }}</p>
                    <p><strong>Top filenames: </strong>{{ analysis_results.results[0].mde.topFileNames }}</p>
                    <p><strong>File product name: </strong>{{ analysis_results.results[0].mde.fileProductName }}</p>
                    <p><strong>File publisher: </strong>{{ analysis_results.results[0].mde.filePublisher }}</p>
                    <p><strong>Signer: </strong>{{ analysis_results.results[0].mde.signer }}</p>
                    <p><strong>Issuer: </strong>{{ analysis_results.results[0].mde.issuer }}</p>
                    <p><strong>IsValidCertificate: </strong>{{ analysis_results.results[0].mde.isValidCertificate }}</p>
                    <p><strong>Determination: </strong>{{ analysis_results.results[0].mde.determinationType }}</p>
                    <p><strong>Determination value: </strong>{{ analysis_results.results[0].mde.determinationValue }}
                    </p>
                    {% elif analysis_results.results[0].mde.host %}
                    <p><strong>Devices: </strong><a href="{{ analysis_results.results[0].mde.link }}" target="_blank">{{
                            analysis_results.results[0].mde.orgPrevalence }}</a></p>
                    <p><strong>First seen: </strong>{{ analysis_results.results[0].mde.orgFirstSeen }}</p>
                    <p><strong>Last seen: </strong>{{ analysis_results.results[0].mde.orgLastSeen }}</p>
                    {% endif %}
                </div>
                {% endif %}
                {% if analysis_results.results[0].threatfox %}
                <div class="card{% if analysis_results.results[0].threatfox and analysis_results.results[0].threatfox.count != 0 %} high-risk"
                    style="background-color: red;" {% else %}"{% endif %}>
                    <h3>ThreatFox</h3>
                    {% if analysis_results.results[0].threatfox.count != 0 %}
                    <p><strong>Count: </strong><a href="{{ analysis_results.results[0].threatfox.link }}"
                            target="_blank">{{ analysis_results.results[0].threatfox.count }}</a></p>
                    <p><strong>Malware: </strong>{{ analysis_results.results[0].threatfox.malware_printable | join(', ')
                        }}</p>
                    {% else %}
                    <p>Not Found</p>
                    {% endif %}
                </div>
                {% endif %}

                {% if analysis_results.results[0].phishtank %}
                <div class="card">
                    <h3>Phishtank</h3>
                    {% if analysis_results.results[0].phishtank.in_database == True and
                    analysis_results.results[0].phishtank.valid == True and
                    analysis_results.results[0].phishtank.verified == True %}
                    <p><a href="{{ analysis_results.results[0].phishtank.phish_detail_page }}" target="_blank">Found
                            (valid and verified)</a></p>
                    {% elif analysis_results.results[0].phishtank.in_database == True and
                    analysis_results.results[0].phishtank.valid == False %}
                    <p><a href="{{ analysis_results.results[0].phishtank.phish_detail_page }}" target="_blank">Found
                            (invalid)</a></p>
                    {% elif analysis_results.results[0].phishtank.in_database == True and
                    analysis_results.results[0].phishtank.verified == False %}
                    <p><a href="{{ analysis_results.results[0].phishtank.phish_detail_page }}" target="_blank">Found
                            (not verified)</a></p>
                    {% elif analysis_results.results[0].phishtank.in_database == False %}
                    <p>Not Found</p>
                    {% else %}
                    <p>Not applicable</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="cards-results-container">
                {% if analysis_results.results[0].google_safe_browsing %}
                <div class="card">
                    <h3>Google Safe Browsing</h3>
                    <p><strong>Threat: </strong>{{ analysis_results.results[0].google_safe_browsing.threat_found }}</p>
                    <p><strong>Details: </strong>{{ analysis_results.results[0].google_safe_browsing.details }}</p>
                </div>
                {% endif %}
                {% if analysis_results.results[0].shodan %}
                <div class="card">
                    <h3>Shodan</h3>
                    <p><strong>Ports: </strong>{{ analysis_results.results[0].shodan.ports | join(', ') }}</p>
                    {% if analysis_results.results[0].shodan.tags | length > 0 %}
                    <p><strong>Tags: </strong>{{ analysis_results.results[0].shodan.tags | join(', ') }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="cards-results-container">
                {% if analysis_results.results[0].google %}
                <div class="card">
                    <h3>Google</h3>
                    <p><strong>Search results: </strong></p>
                    {% if analysis_results.results[0].google.results | length > 0 %}
                    {% for search_result in analysis_results.results[0].google.results %}
                    <p><a href="{{ search_result.url }}" target="_blank" title="{{ search_result.description }}">{{
                            search_result.title }}</a></p>
                    {% endfor %}
                    {% else %}
                    <p>Not Found</p>
                    {% endif %}
                </div>
                {% endif %}
                {% if analysis_results.results[0].github %}
                <div class="card">
                    <h3>Github</h3>
                    <p><strong>Search results: </strong></p>
                    {% if analysis_results.results[0].github.results | length > 0 %}
                    {% for search_result in analysis_results.results[0].github.results %}
                    <p><a href="{{ search_result.url }}" target="_blank" title="{{ search_result.description }}">{{
                            search_result.title }}</a></p>
                    {% endfor %}
                    {% else %}
                    <p>Not Found</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="cards-results-container">
                {% if analysis_results.results[0].ioc_one_html %}
                <div class="card">
                    <h3>Ioc.One (HTML)</h3>
                    <p><strong>Search results: </strong></p>
                    {% if analysis_results.results[0].ioc_one_html.results | length > 0 %}
                    {% for search_result in analysis_results.results[0].ioc_one_html.results %}
                    <p><a href="{{ search_result.source }}" target="_blank" title="{{ search_result.header }}">{{
                            search_result.title }}</a></p>
                    {% endfor %}
                    {% else %}
                    <p>Not Found</p>
                    {% endif %}
                </div>
                {% endif %}
                {% if analysis_results.results[0].ioc_one_pdf %}
                <div class="card">
                    <h3>Ioc.One (PDF)</h3>
                    <p><strong>Search results: </strong></p>
                    {% if analysis_results.results[0].ioc_one_pdf.results | length > 0 %}
                    {% for search_result in analysis_results.results[0].ioc_one_pdf.results %}
                    <p><a href="{{ search_result.source }}" target="_blank" title="{{ search_result.header }}">{{
                            search_result.title }}</a></p>
                    {% endfor %}
                    {% else %}
                    <p>Not Found</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="cards-results-container">
                {% if analysis_results.results[0].opencti %}
                <div class="card{% if analysis_results.results[0].opencti.latest_indicator_link and not analysis_results.results[0].opencti.revoked %} warning-row" style="background-color: orange;"{% else %}"{% endif %}>
                    <h3>OpenCTI</h3>
                    <p><strong>Global count: </strong>{{ analysis_results.results[0].opencti.global_count }}</p>
                    <p><strong>Entity counts:</strong></p>
                    <ul>
                        {% for entity, count in analysis_results.results[0].opencti.entity_counts.items() %}
                        <li>{{ entity }}: {{ count }}</li>
                        {% endfor %}
                    </ul>
                    <p><strong>Search link: </strong><a href="{{ analysis_results.results[0].opencti.search_link }}"
                            target="_blank">See on OpenCTI</a></p>
                    <p><strong>Latest Entity Created At: </strong>{{ analysis_results.results[0].opencti.latest_created_at }}</p>
                    {% if analysis_results.results[0].opencti.latest_indicator_link %}
                    <p><strong>Latest Indicator Name: </strong>{{ analysis_results.results[0].opencti.latest_indicator_name }}</p>
                    <p><strong>Latest Indicator Link: </strong><a href="{{ analysis_results.results[0].opencti.latest_indicator_link }}" target="_blank">See Indicator</a></p>
                    <p><strong>OpenCTI Score: </strong>{{ analysis_results.results[0].opencti.x_opencti_score }} / 100</p>
                    <p><strong>Confidence: </strong>{{ analysis_results.results[0].opencti.confidence }}</p>
                    <p><strong>Revoked: </strong>{{ analysis_results.results[0].opencti.revoked }}</p>
                    <p><strong>Valid From: </strong>{{ analysis_results.results[0].opencti.valid_from }}</p>
                    <p><strong>Valid Until: </strong>{{ analysis_results.results[0].opencti.valid_until }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
    </div>
    <div class="end-of-cards">

    </div>

    <script>
        $(document).ready(function () {
            $('#resultsTable').DataTable({
                // Enable column reordering
                colReorder: true,
                // Enable responsive
                responsive: true,
                // Disable search
                searching: false,
                // Disable paging
                paging: false,
                ordering: true,
                info: false,
                // show sorting icons in th
                orderCellsTop: true
            });
        });

        // remove cards-results-container container if empty
        function checkCardsBasicInfo() {
            document.querySelectorAll('.cards-results-container').forEach(container => {
                if (container.children.length === 0) {
                    container.style.display = 'none';
                }
            });
        }

        checkCardsBasicInfo();
    </script>

</body>
<footer class="footer">
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/history">History</a></li>
            <li><a href="/stats">Statistics</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="https://github.com/stanfrbd/cyberbro" target="_blank">GitHub</a></li>
        </ul>
    </nav>
</footer>

</html>
<script>
    const moonIcon = "https://img.icons8.com/ios-filled/50/ffffff/moon-symbol.png";
    const sunIcon = "https://img.icons8.com/ios-filled/50/ffffff/sun.png";

    function filterTable() {
        const searchInput = document.getElementById("searchInput").value.toLowerCase();
        const countryFilter = document.getElementById("countryFilter").value.toLowerCase();
        const riskFilter = document.getElementById("riskFilter").value.toLowerCase();
        const detectionFilter = document.getElementById("detectionFilter").value.toLowerCase();
        const typeFilter = document.getElementById("typeFilter").value.toLowerCase();
        const proxyVpnFilter = document.getElementById("proxyVpnFilter").value.toLowerCase();
        const table = document.getElementById("resultsTable");
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) {
            let td = tr[i].getElementsByTagName("td");
            let showRow = true;

            if (searchInput) {
                showRow = Array.from(td).some(cell => cell.innerText.toLowerCase().includes(searchInput));
            }

            if (showRow && countryFilter !== "all") {

                const countrySpan = tr[i].querySelector(".country");
                const country = countrySpan ? countrySpan.className.split("-")[1] : "";
                showRow = country === countryFilter;
            }

            if (showRow && riskFilter !== "all") {
                const riskClass = tr[i].classList.contains("high-risk") ? "high" : "low";
                showRow = riskClass === riskFilter;
            }

            if (showRow && detectionFilter !== "all") {
                const detectionClass = tr[i].classList.contains("high-detection") ? "high" : tr[i].classList.contains("clean-detection") ? "clean" : "low";
                showRow = detectionClass === detectionFilter;
            }

            if (showRow && typeFilter !== "all") {
                showRow = td[1].innerText.toLowerCase() === typeFilter;
            }

            // Spur or IP Quality Score
            if (showRow && proxyVpnFilter !== "all") {
                let anonymousResult = "";
                anonymousResult = tr[i].innerText.toLowerCase();
                showRow = anonymousResult.includes(proxyVpnFilter);
            }

            tr[i].style.display = showRow ? "" : "none";
        }
    }

    function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("countryFilter").value = "all";
        document.getElementById("riskFilter").value = "all";
        document.getElementById("detectionFilter").value = "all";
        document.getElementById("typeFilter").value = "all";
        document.getElementById("proxyVpnFilter").value = "all";
        filterTable();
    }

    function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
        updateDarkModeIcon();
    }

    function updateDarkModeIcon() {
        const darkModeIcon = document.getElementById("darkModeIcon");
        if (document.body.classList.contains("dark-mode")) {
            darkModeIcon.src = sunIcon;
            darkModeIcon.alt = "Light Mode";
        } else {
            darkModeIcon.src = moonIcon;
            darkModeIcon.alt = "Dark Mode";
        }
    }

    function applyDarkMode() {
        if (localStorage.getItem("darkMode") === "true") {
            document.body.classList.add("dark-mode");
        }
        updateDarkModeIcon();
    }

    applyDarkMode();
</script>